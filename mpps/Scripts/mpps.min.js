$(function () { if (window.addEventListener) { window.addEventListener("message", mpps.processMessage, false) } else { if (window.attachEvent) { window.attachEvent("onmessage", mpps.processMessage, false) } } }); mpps = {}; mpps.deferred = {}; mpps.processMessage = function (a) { mpps.deferred.resolve(a.data) }; mpps.buildPaymentForm = function (a) { var b = $.Deferred(); $(a).append('<div class="mpps-input-group"><label class="mpps-label mpps-label-card-type">Type:</label><input type="text" class="mpps-input mpps-input-card-type" data-mpps="card_type"></div>'); $(a).append('<div class="mpps-input-group"><label class="mpps-label mpps-label-card-number">Number:</label><input type="text" class="mpps-input mpps-input-card-number" data-mpps="card_number" /></div>'); $(a).append('<div class="mpps-input-group"><label class="mpps-label mpps-label-card-expiry-date">Expiration date:</label><input type="text" class="mpps-input mpps-input-card-expiry-date" data-mpps="card_expiry_date" /></div>'); $(a).append('<div class="mpps-input-group"><label class="mpps-label mpps-label-card-cvn">CVN:</label><input type="text" class="mpps-input mpps-input-card-cvn" data-mpps="card_cvn" /></div>'); $("input[data-mpps='card_type']").val("001"); $("input[data-mpps='card_number']").val("4242424242424242"); $("input[data-mpps='card_expiry_date']").val("11-2020"); $("input[data-mpps='card_cvn']").val("120"); b.resolve(); return b.promise() }; mpps.ISODateString = function (b) { function a(c) { return c < 10 ? "0" + c : c } return b.getUTCFullYear() + "-" + a(b.getUTCMonth() + 1) + "-" + a(b.getUTCDate()) + "T" + a(b.getUTCHours()) + ":" + a(b.getUTCMinutes()) + ":" + a(b.getUTCSeconds()) + "Z" }; mpps.createPaymentToken = function (a) { mpps.deferred = $.Deferred(); var b = { override_custom_receipt_page: mpps.rootUrl + "/receipt.aspx", transaction_uuid: new Date().getTime(), signed_field_names: "access_key,profile_id,transaction_uuid,signed_field_names,unsigned_field_names,signed_date_time,locale,transaction_type,reference_number,currency,payment_method,bill_to_forename,bill_to_surname,bill_to_email,bill_to_phone,bill_to_address_line1,bill_to_address_city,bill_to_address_state,bill_to_address_country,bill_to_address_postal_code,override_custom_receipt_page", unsigned_field_names: "card_type,card_number,card_expiry_date,card_cvn", signed_date_time: mpps.ISODateString(new Date()), locale: "en", transaction_type: "create_payment_token", reference_number: a.referenceNumber, currency: "USD", payment_method: "card", bill_to_forename: a.contactInfo.firstName, bill_to_surname: a.contactInfo.lastName, bill_to_address_city: a.contactInfo.city, bill_to_address_country: a.contactInfo.country, bill_to_address_line1: a.contactInfo.addressLine1, bill_to_address_state: a.contactInfo.state, bill_to_address_postal_code: a.contactInfo.postalCode, bill_to_email: a.contactInfo.email, bill_to_phone: a.contactInfo.phone }; $.ajax({ type: "POST", url: mpps.rootUrl + "/api/signing/", contentType: "application/json", headers: { Authorization: a.key + ":" + mpps._k + ":" + mpps.sign("profile=" + a.key + ",key=" + mpps._k) }, data: JSON.stringify(b), success: function (c) { mpps.buildTokenCreateForm(c) }, error: function (e, d, c) { mpps.deferred.reject(c) } }); return mpps.deferred }; mpps.sign = function (b) { var a = CryptoJS.HmacSHA256(b, mpps._s); return a.toString(CryptoJS.enc.Base64) }; mpps.buildTokenCreateForm = function (b) { var a = $("#mpps-payment_frame"); if (a.length) { a.remove() } $("body").append('<iframe id="mpps-payment_frame" name="payment_frame" frameborder="0" style="height:0px; width:0px" />'); var c = $("#mpps-payment_frame")[0].contentWindow; c.document.open(); c.document.write("<html><head></head><body>"); c.document.write('<form id="mpps-checkout-form" method="post" action="' + b.url + '">'); c.document.write('<input type="hidden" name="access_key" value="' + b.access_key + '"  />'); c.document.write('<input type="hidden" name="profile_id" value="' + b.profile_id + '"  />'); c.document.write('<input type="hidden" name="override_custom_receipt_page" value="' + b.override_custom_receipt_page + '" />'); c.document.write('<input type="hidden" name="transaction_uuid" value="' + b.transaction_uuid + '"  />'); c.document.write('<input type="hidden" name="signed_field_names" value="' + b.signed_field_names + '" />'); c.document.write('<input type="hidden" name="unsigned_field_names" value="' + b.unsigned_field_names + '" />'); c.document.write('<input type="hidden" name="signed_date_time" value="' + b.signed_date_time + '"  />'); c.document.write('<input type="hidden" name="locale" value="' + b.locale + '" />'); c.document.write('<input type="hidden" name="transaction_type" value="' + b.transaction_type + '" />'); c.document.write('<input type="hidden" name="reference_number" value="' + b.reference_number + '"/>'); c.document.write('<input type="hidden" name="currency" value="' + b.currency + '" />'); c.document.write('<input type="hidden" name="payment_method" value="' + b.payment_method + '" />'); c.document.write('<input type="hidden" name="bill_to_forename" value="' + b.bill_to_forename + '"/>'); c.document.write('<input type="hidden" name="bill_to_surname" value="' + b.bill_to_surname + '" />'); c.document.write('<input type="hidden" name="bill_to_email" value="' + b.bill_to_email + '" />'); c.document.write('<input type="hidden" name="bill_to_phone" value="' + b.bill_to_phone + '" />'); c.document.write('<input type="hidden" name="bill_to_address_line1" value="' + b.bill_to_address_line1 + '" />'); c.document.write('<input type="hidden" name="bill_to_address_city" value="' + b.bill_to_address_city + '" />'); c.document.write('<input type="hidden" name="bill_to_address_state" value="' + b.bill_to_address_state + '" />'); c.document.write('<input type="hidden" name="bill_to_address_country" value="' + b.bill_to_address_country + '" />'); c.document.write('<input type="hidden" name="bill_to_address_postal_code"" value="' + b.bill_to_address_postal_code + '" />'); c.document.write('<input type="hidden" name="card_type" value="' + $("input[data-mpps='card_type']").val() + '" />'); c.document.write('<input type="hidden" name="card_number" value="' + $("input[data-mpps='card_number']").val() + '" />'); c.document.write('<input type="hidden" name="card_expiry_date" value="' + $("input[data-mpps='card_expiry_date']").val() + '" />'); c.document.write('<input type="hidden" name="card_cvn" value="' + $("input[data-mpps='card_cvn']").val() + '" />'); c.document.write('<input type="hidden" name="signature" value="' + b.signature + '">'); c.document.write("</form>"); c.document.write("</body></html>"); c.document.body.onload = function () { c.document.getElementById("mpps-checkout-form").submit() }; c.document.close() };