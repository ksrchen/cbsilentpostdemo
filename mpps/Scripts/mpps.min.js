$(function () { if (window.addEventListener) { window.addEventListener("message", mpps.processMessage, false) } else { if (window.attachEvent) { window.attachEvent("onmessage", mpps.processMessage, false) } } }); Number.prototype.pad = function (a) { var b = String(this); if (typeof (a) !== "number") { a = 2 } while (b.length < a) { b = "0" + b } return b }; mpps = (function () { var l; var g = false; var e, k, a; function h(m) { l.resolve(m.data) } function b(m) { var p = [{ value: "001", text: "Visa" }, { value: "002", text: "MasterCard" }, { value: "003", text: "American Express" }, { value: "004", text: "Discover" }]; var n = $.Deferred(); $(m).append('<div class="mpps-input-group"><label class="mpps-label mpps-label-card-type">Type:</label><select class="mpps-input mpps-input-card-type" data-mpps="card_type"></div>'); $(m).append('<div class="mpps-input-group"><label class="mpps-label mpps-label-card-number">Number:</label><input type="text" class="mpps-input mpps-input-card-number" data-mpps="card_number" /></div>'); $(m).append('<div class="mpps-input-group"><label class="mpps-label mpps-label-card-expiry-date">Expiration date:</label><select class="mpps-input mpps-input-card-expiry-month" data-mpps="card_expiry_month"/>&nbsp;<select class="mpps-input mpps-input-card-expiry-year" data-mpps="card_expiry_year"/></div>'); $(m).append('<div class="mpps-input-group"><label class="mpps-label mpps-label-card-cvn">CVN:</label><input type="text" class="mpps-input mpps-input-card-cvn" data-mpps="card_cvn" /></div>'); $.each(p, function (q, r) { $('select[data-mpps="card_type"').append($("<option>", { value: r.value, text: r.text })) }); for (i = 1; i <= 12; i++) { $('select[data-mpps="card_expiry_month"').append($("<option>", { value: i.pad(), text: i.pad() })) } var o = (new Date()).getFullYear(); for (i = o; i <= o + 10; i++) { $('select[data-mpps="card_expiry_year"').append($("<option>", { value: String(i), text: String(i) })) } $('input[data-mpps="card_number"]').mask("9999999999999999"); $('input[data-mpps="card_cvn"]').mask("999"); n.resolve(); return n.promise() } function d(m) { l = $.Deferred(); var o = $("input[data-mpps='card_number']").val(); if (!o.length > 0) { l.reject("credit card number is required"); return l } var n = $("input[data-mpps='card_cvn']").val(); if (!n.length > 0) { l.reject("CVN is required"); return l } var p = { override_custom_receipt_page: a + "/receipt.aspx", transaction_uuid: new Date().getTime(), signed_field_names: "access_key,profile_id,transaction_uuid,signed_field_names,unsigned_field_names,signed_date_time,locale,transaction_type,reference_number,currency,payment_method,bill_to_forename,bill_to_surname,bill_to_email,bill_to_phone,bill_to_address_line1,bill_to_address_city,bill_to_address_state,bill_to_address_country,bill_to_address_postal_code,override_custom_receipt_page", unsigned_field_names: "card_type,card_number,card_expiry_date,card_cvn", locale: "en", transaction_type: "create_payment_token", reference_number: m.referenceNumber, currency: "USD", payment_method: "card", bill_to_forename: m.billingContact.firstName, bill_to_surname: m.billingContact.lastName, bill_to_address_city: m.billingContact.city, bill_to_address_country: m.billingContact.country, bill_to_address_line1: m.billingContact.addressLine1, bill_to_address_state: m.billingContact.state, bill_to_address_postal_code: m.billingContact.postalCode, bill_to_email: m.billingContact.email, bill_to_phone: m.billingContact.phone, }; $.ajax({ type: "POST", url: a + "/api/signing/", contentType: "application/json", headers: { Authorization: m.profileKey + ":" + e + ":" + c("profile=" + m.profileKey + ",key=" + e) }, data: JSON.stringify(p), success: function (q) { f(q) }, error: function (t, r, q) { l.reject(q) } }); return l } function c(n) { var m = CryptoJS.HmacSHA256(n, k); return m.toString(CryptoJS.enc.Base64) } function f(n) { var m = $("#mpps-payment_frame"); if (m.length) { m.remove() } $("body").append('<iframe id="mpps-payment_frame" name="payment_frame" frameborder="0" style="height:0px; width:0px" />'); var o = $("#mpps-payment_frame")[0].contentWindow; o.document.open(); o.document.write("<html><head></head><body>"); o.document.write('<form id="mpps-checkout-form" method="post" action="' + n.url + '">'); o.document.write('<input type="hidden" name="access_key" value="' + n.access_key + '"  />'); o.document.write('<input type="hidden" name="profile_id" value="' + n.profile_id + '"  />'); o.document.write('<input type="hidden" name="override_custom_receipt_page" value="' + n.override_custom_receipt_page + '" />'); o.document.write('<input type="hidden" name="transaction_uuid" value="' + n.transaction_uuid + '"  />'); o.document.write('<input type="hidden" name="signed_field_names" value="' + n.signed_field_names + '" />'); o.document.write('<input type="hidden" name="unsigned_field_names" value="' + n.unsigned_field_names + '" />'); o.document.write('<input type="hidden" name="signed_date_time" value="' + n.signed_date_time + '"  />'); o.document.write('<input type="hidden" name="locale" value="' + n.locale + '" />'); o.document.write('<input type="hidden" name="transaction_type" value="' + n.transaction_type + '" />'); o.document.write('<input type="hidden" name="reference_number" value="' + n.reference_number + '"/>'); o.document.write('<input type="hidden" name="currency" value="' + n.currency + '" />'); o.document.write('<input type="hidden" name="payment_method" value="' + n.payment_method + '" />'); o.document.write('<input type="hidden" name="bill_to_forename" value="' + n.bill_to_forename + '"/>'); o.document.write('<input type="hidden" name="bill_to_surname" value="' + n.bill_to_surname + '" />'); o.document.write('<input type="hidden" name="bill_to_email" value="' + n.bill_to_email + '" />'); o.document.write('<input type="hidden" name="bill_to_phone" value="' + n.bill_to_phone + '" />'); o.document.write('<input type="hidden" name="bill_to_address_line1" value="' + n.bill_to_address_line1 + '" />'); o.document.write('<input type="hidden" name="bill_to_address_city" value="' + n.bill_to_address_city + '" />'); o.document.write('<input type="hidden" name="bill_to_address_state" value="' + n.bill_to_address_state + '" />'); o.document.write('<input type="hidden" name="bill_to_address_country" value="' + n.bill_to_address_country + '" />'); o.document.write('<input type="hidden" name="bill_to_address_postal_code"" value="' + n.bill_to_address_postal_code + '" />'); o.document.write('<input type="hidden" name="card_type" value="' + $("select[data-mpps='card_type']").val() + '" />'); o.document.write('<input type="hidden" name="card_number" value="' + $("input[data-mpps='card_number']").val() + '" />'); o.document.write('<input type="hidden" name="card_expiry_date" value="' + $("select[data-mpps='card_expiry_month']").val() + "-" + $("select[data-mpps='card_expiry_year']").val() + '" />'); o.document.write('<input type="hidden" name="card_cvn" value="' + $("input[data-mpps='card_cvn']").val() + '" />'); o.document.write('<input type="hidden" name="signature" value="' + n.signature + '">'); o.document.write("</form>"); o.document.write("</body></html>"); o.document.body.onload = function () { o.document.getElementById("mpps-checkout-form").submit() }; o.document.close() } function j(o, m, n) { if (g === false) { a = o; e = m; k = n; g = true } } return { init: j, processMessage: h, buildPaymentForm: b, createPaymentToken: d } }());