$(function () { if (window.addEventListener) { window.addEventListener("message", mpps.processMessage, false) } else { if (window.attachEvent) { window.attachEvent("onmessage", mpps.processMessage, false) } } }); mpps = (function () { var k; var g = false; var e, j, a; function h(l) { k.resolve(l.data) } function b(l) { var m = $.Deferred(); $(l).append('<div class="mpps-input-group"><label class="mpps-label mpps-label-card-type">Type:</label><input type="text" class="mpps-input mpps-input-card-type" data-mpps="card_type"></div>'); $(l).append('<div class="mpps-input-group"><label class="mpps-label mpps-label-card-number">Number:</label><input type="text" class="mpps-input mpps-input-card-number" data-mpps="card_number" /></div>'); $(l).append('<div class="mpps-input-group"><label class="mpps-label mpps-label-card-expiry-date">Expiration date:</label><input type="text" class="mpps-input mpps-input-card-expiry-date" data-mpps="card_expiry_date" /></div>'); $(l).append('<div class="mpps-input-group"><label class="mpps-label mpps-label-card-cvn">CVN:</label><input type="text" class="mpps-input mpps-input-card-cvn" data-mpps="card_cvn" /></div>'); $("input[data-mpps='card_type']").val("001"); $("input[data-mpps='card_number']").val("4242424242424242"); $("input[data-mpps='card_expiry_date']").val("11-2020"); $("input[data-mpps='card_cvn']").val("120"); m.resolve(); return m.promise() } function d(l) { k = $.Deferred(); var m = { override_custom_receipt_page: a + "/receipt.aspx", transaction_uuid: new Date().getTime(), signed_field_names: "access_key,profile_id,transaction_uuid,signed_field_names,unsigned_field_names,signed_date_time,locale,transaction_type,reference_number,currency,payment_method,bill_to_forename,bill_to_surname,bill_to_email,bill_to_phone,bill_to_address_line1,bill_to_address_city,bill_to_address_state,bill_to_address_country,bill_to_address_postal_code,override_custom_receipt_page", unsigned_field_names: "card_type,card_number,card_expiry_date,card_cvn", locale: "en", transaction_type: "create_payment_token", reference_number: l.referenceNumber, currency: "USD", payment_method: "card", bill_to_forename: l.billingContact.firstName, bill_to_surname: l.billingContact.lastName, bill_to_address_city: l.billingContact.city, bill_to_address_country: l.billingContact.country, bill_to_address_line1: l.billingContact.addressLine1, bill_to_address_state: l.billingContact.state, bill_to_address_postal_code: l.billingContact.postalCode, bill_to_email: l.billingContact.email, bill_to_phone: l.billingContact.phone }; $.ajax({ type: "POST", url: a + "/api/signing/", contentType: "application/json", headers: { Authorization: l.profileKey + ":" + e + ":" + c("profile=" + l.profileKey + ",key=" + e) }, data: JSON.stringify(m), success: function (n) { f(n) }, error: function (p, o, n) { k.reject(n) } }); return k } function c(m) { var l = CryptoJS.HmacSHA256(m, j); return l.toString(CryptoJS.enc.Base64) } function f(m) { var l = $("#mpps-payment_frame"); if (l.length) { l.remove() } $("body").append('<iframe id="mpps-payment_frame" name="payment_frame" frameborder="0" style="height:0px; width:0px" />'); var n = $("#mpps-payment_frame")[0].contentWindow; n.document.open(); n.document.write("<html><head></head><body>"); n.document.write('<form id="mpps-checkout-form" method="post" action="' + m.url + '">'); n.document.write('<input type="hidden" name="access_key" value="' + m.access_key + '"  />'); n.document.write('<input type="hidden" name="profile_id" value="' + m.profile_id + '"  />'); n.document.write('<input type="hidden" name="override_custom_receipt_page" value="' + m.override_custom_receipt_page + '" />'); n.document.write('<input type="hidden" name="transaction_uuid" value="' + m.transaction_uuid + '"  />'); n.document.write('<input type="hidden" name="signed_field_names" value="' + m.signed_field_names + '" />'); n.document.write('<input type="hidden" name="unsigned_field_names" value="' + m.unsigned_field_names + '" />'); n.document.write('<input type="hidden" name="signed_date_time" value="' + m.signed_date_time + '"  />'); n.document.write('<input type="hidden" name="locale" value="' + m.locale + '" />'); n.document.write('<input type="hidden" name="transaction_type" value="' + m.transaction_type + '" />'); n.document.write('<input type="hidden" name="reference_number" value="' + m.reference_number + '"/>'); n.document.write('<input type="hidden" name="currency" value="' + m.currency + '" />'); n.document.write('<input type="hidden" name="payment_method" value="' + m.payment_method + '" />'); n.document.write('<input type="hidden" name="bill_to_forename" value="' + m.bill_to_forename + '"/>'); n.document.write('<input type="hidden" name="bill_to_surname" value="' + m.bill_to_surname + '" />'); n.document.write('<input type="hidden" name="bill_to_email" value="' + m.bill_to_email + '" />'); n.document.write('<input type="hidden" name="bill_to_phone" value="' + m.bill_to_phone + '" />'); n.document.write('<input type="hidden" name="bill_to_address_line1" value="' + m.bill_to_address_line1 + '" />'); n.document.write('<input type="hidden" name="bill_to_address_city" value="' + m.bill_to_address_city + '" />'); n.document.write('<input type="hidden" name="bill_to_address_state" value="' + m.bill_to_address_state + '" />'); n.document.write('<input type="hidden" name="bill_to_address_country" value="' + m.bill_to_address_country + '" />'); n.document.write('<input type="hidden" name="bill_to_address_postal_code"" value="' + m.bill_to_address_postal_code + '" />'); n.document.write('<input type="hidden" name="card_type" value="' + $("input[data-mpps='card_type']").val() + '" />'); n.document.write('<input type="hidden" name="card_number" value="' + $("input[data-mpps='card_number']").val() + '" />'); n.document.write('<input type="hidden" name="card_expiry_date" value="' + $("input[data-mpps='card_expiry_date']").val() + '" />'); n.document.write('<input type="hidden" name="card_cvn" value="' + $("input[data-mpps='card_cvn']").val() + '" />'); n.document.write('<input type="hidden" name="signature" value="' + m.signature + '">'); n.document.write("</form>"); n.document.write("</body></html>"); n.document.body.onload = function () { n.document.getElementById("mpps-checkout-form").submit() }; n.document.close() } function i(n, l, m) { if (g === false) { a = n; e = l; j = m; g = true } } return { init: i, processMessage: h, buildPaymentForm: b, createPaymentToken: d } }());